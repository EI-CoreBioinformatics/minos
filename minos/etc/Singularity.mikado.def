Bootstrap: docker
From: ubuntu:20.04

%test
    python3 --version
    python3 -c "import numpy"
    mikado --help

%environment
    export PYTHONDONTWRITEBYTECODE=true

%post

    ### Install your packages ###

    export PYTHONDONTWRITEBYTECODE=true

    mkdir /opt/software
    cd /opt/software/

    apt update
    apt install -y software-properties-common
    add-apt-repository universe
    add-apt-repository multiverse
    add-apt-repository restricted
    apt update
    apt install -y zlib1g-dev libboost-dev '^libboost-.*71-dev' build-essential automake autoconf curl libbz2-dev libncurses-dev lzma-dev python3 python3-numpy python3-dev python3-scipy python3-pandas python3-pip libtool liblzma-dev git pip wget libcurl4-openssl-dev  pkg-config
    apt -y install software-properties-common build-essential zlib1g-dev libbz2-dev libncurses5-dev libgdbm-dev libnss3-dev libssl-dev gzip unzip

    pip --no-cache-dir   install numpy
    pip --no-cache-dir  install sortedcontainers
    pip --no-cache-dir  install pandas
    pip --no-cache-dir  install Cython

    # Mikado
    pip3 --no-cache-dir install wheel
    pip3 --no-cache-dir install python-rapidjson
    pip3 install "Mikado>=2.0"

    # Samtools
    wget https://github.com/samtools/samtools/releases/download/1.11/samtools-1.11.tar.bz2
    tar xaf samtools-1.11.tar.bz2
    mv samtools-1.11 samtools  # Necessary for augustus
    cd samtools  # and similarly for bcftools and htslib
    ./configure --enable-libcurl --enable-plugins --enable-s3
    make -j 20
    make install
    samtools --help 2>&1 | head
    cd ../
    rm samtools-1.11.tar.bz2

    # Portcullis
    git clone https://github.com/EI-CoreBioinformatics/portcullis.git
    cd portcullis
    ./autogen.sh
    ./configure
    make -j 8
    make install
    cd /opt/software

    # Diamond
    git clone https://github.com/bbuchfink/diamond.git
    cd diamond
    mkdir build
    cd build
    cmake ../
    make
    make install
    cd ../../
    rm -rf diamond
    diamond --help

    # Prodigal
    wget https://github.com/hyattpd/Prodigal/releases/download/v2.6.3/prodigal.linux
    chmod +x prodigal.linux
    mv prodigal.linux /usr/local/bin/prodigal
    prodigal -h

    # Create global folder
    mkdir -p /global && cd /global

%apprun snakemake
    snakemake "@"

%apprun mikado
    mikado "@"

%apprun daijin
    daijin "@"

%apprun prodigal
    prodigal "@"

%apprun samtools
    samtools "@"

%apprun diamond
    diamond "@"

%apprun portcullis
    portcullis "@"
